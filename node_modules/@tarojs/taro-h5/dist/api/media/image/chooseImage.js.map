{"version":3,"file":"chooseImage.js","sources":["../../../../src/api/media/image/chooseImage.ts"],"sourcesContent":["import Taro from '@tarojs/api'\n\nimport { getParameterError, shouldBeObject } from '../../../utils'\nimport { MethodHandler } from '../../../utils/handler'\n\n/**\n * 从本地相册选择图片或使用相机拍照。\n */\nexport const chooseImage: typeof Taro.chooseImage = function (options) {\n  // options must be an Object\n  const isObject = shouldBeObject(options)\n  if (!isObject.flag) {\n    const res = { errMsg: `chooseImage:fail ${isObject.msg}` }\n    console.error(res.errMsg)\n    return Promise.reject(res)\n  }\n\n  const {\n    count = 1,\n    success,\n    fail,\n    complete,\n    imageId = 'taroChooseImage',\n    sourceType = ['album', 'camera']\n  } = options\n  const handle = new MethodHandler({ name: 'chooseImage', success, fail, complete })\n  const res: Partial<Taro.chooseImage.SuccessCallbackResult> = {\n    tempFilePaths: [],\n    tempFiles: []\n  }\n  const sourceTypeString = sourceType && sourceType.toString()\n  const acceptableSourceType = ['user', 'environment', 'camera']\n\n  if (count && typeof count !== 'number') {\n    res.errMsg = getParameterError({\n      para: 'count',\n      correct: 'Number',\n      wrong: count\n    })\n    return handle.fail(res)\n  }\n\n  let el = document.getElementById(imageId)\n  if (!el) {\n    const obj = document.createElement('input')\n    obj.setAttribute('type', 'file')\n    obj.setAttribute('id', imageId)\n    if (count > 1) {\n      obj.setAttribute('multiple', 'multiple')\n    }\n    if (acceptableSourceType.indexOf(sourceTypeString) > -1) {\n      obj.setAttribute('capture', sourceTypeString)\n    }\n    obj.setAttribute('accept', 'image/*')\n    obj.setAttribute('style', 'position: fixed; top: -4000px; left: -3000px; z-index: -300;')\n    document.body.appendChild(obj)\n    el = document.getElementById(imageId)\n  } else {\n    if (count > 1) {\n      el.setAttribute('multiple', 'multiple')\n    } else {\n      el.removeAttribute('multiple')\n    }\n    if (acceptableSourceType.indexOf(sourceTypeString) > -1) {\n      el.setAttribute('capture', sourceTypeString)\n    } else {\n      el.removeAttribute('capture')\n    }\n  }\n\n  return new Promise((resolve, reject) => {\n    const TaroMouseEvents = document.createEvent('MouseEvents')\n    TaroMouseEvents.initEvent('click', true, true)\n    if (el) {\n      el.dispatchEvent(TaroMouseEvents)\n      el.onchange = function (e) {\n        const target = e.target as HTMLInputElement\n        if (target) {\n          const files = target.files || []\n          const arr = [...files]\n          arr && arr.forEach(item => {\n            const blob = new Blob([item], {\n              type: item.type\n            })\n            const url = URL.createObjectURL(blob)\n            res.tempFilePaths?.push(url)\n            res.tempFiles?.push({ path: url, size: item.size, type: item.type, originalFileObj: item })\n          })\n          handle.success(res, { resolve, reject })\n          target.value = ''\n        }\n      }\n    }\n  })\n}\n"],"names":[],"mappings":";;;AAKA;;AAEG;AACI,MAAM,WAAW,GAA4B,UAAU,OAAO,EAAA;;AAEnE,IAAA,MAAM,QAAQ,GAAG,cAAc,CAAC,OAAO,CAAC,CAAA;AACxC,IAAA,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE;QAClB,MAAM,GAAG,GAAG,EAAE,MAAM,EAAE,CAAoB,iBAAA,EAAA,QAAQ,CAAC,GAAG,CAAE,CAAA,EAAE,CAAA;AAC1D,QAAA,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAA;AACzB,QAAA,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAA;AAC3B,KAAA;IAED,MAAM,EACJ,KAAK,GAAG,CAAC,EACT,OAAO,EACP,IAAI,EACJ,QAAQ,EACR,OAAO,GAAG,iBAAiB,EAC3B,UAAU,GAAG,CAAC,OAAO,EAAE,QAAQ,CAAC,EACjC,GAAG,OAAO,CAAA;AACX,IAAA,MAAM,MAAM,GAAG,IAAI,aAAa,CAAC,EAAE,IAAI,EAAE,aAAa,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC,CAAA;AAClF,IAAA,MAAM,GAAG,GAAoD;AAC3D,QAAA,aAAa,EAAE,EAAE;AACjB,QAAA,SAAS,EAAE,EAAE;KACd,CAAA;IACD,MAAM,gBAAgB,GAAG,UAAU,IAAI,UAAU,CAAC,QAAQ,EAAE,CAAA;IAC5D,MAAM,oBAAoB,GAAG,CAAC,MAAM,EAAE,aAAa,EAAE,QAAQ,CAAC,CAAA;AAE9D,IAAA,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE;AACtC,QAAA,GAAG,CAAC,MAAM,GAAG,iBAAiB,CAAC;AAC7B,YAAA,IAAI,EAAE,OAAO;AACb,YAAA,OAAO,EAAE,QAAQ;AACjB,YAAA,KAAK,EAAE,KAAK;AACb,SAAA,CAAC,CAAA;AACF,QAAA,OAAO,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;AACxB,KAAA;IAED,IAAI,EAAE,GAAG,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,CAAA;IACzC,IAAI,CAAC,EAAE,EAAE;QACP,MAAM,GAAG,GAAG,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAA;AAC3C,QAAA,GAAG,CAAC,YAAY,CAAC,MAAM,EAAE,MAAM,CAAC,CAAA;AAChC,QAAA,GAAG,CAAC,YAAY,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;QAC/B,IAAI,KAAK,GAAG,CAAC,EAAE;AACb,YAAA,GAAG,CAAC,YAAY,CAAC,UAAU,EAAE,UAAU,CAAC,CAAA;AACzC,SAAA;QACD,IAAI,oBAAoB,CAAC,OAAO,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,EAAE;AACvD,YAAA,GAAG,CAAC,YAAY,CAAC,SAAS,EAAE,gBAAgB,CAAC,CAAA;AAC9C,SAAA;AACD,QAAA,GAAG,CAAC,YAAY,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAA;AACrC,QAAA,GAAG,CAAC,YAAY,CAAC,OAAO,EAAE,8DAA8D,CAAC,CAAA;AACzF,QAAA,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAA;AAC9B,QAAA,EAAE,GAAG,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,CAAA;AACtC,KAAA;AAAM,SAAA;QACL,IAAI,KAAK,GAAG,CAAC,EAAE;AACb,YAAA,EAAE,CAAC,YAAY,CAAC,UAAU,EAAE,UAAU,CAAC,CAAA;AACxC,SAAA;AAAM,aAAA;AACL,YAAA,EAAE,CAAC,eAAe,CAAC,UAAU,CAAC,CAAA;AAC/B,SAAA;QACD,IAAI,oBAAoB,CAAC,OAAO,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,EAAE;AACvD,YAAA,EAAE,CAAC,YAAY,CAAC,SAAS,EAAE,gBAAgB,CAAC,CAAA;AAC7C,SAAA;AAAM,aAAA;AACL,YAAA,EAAE,CAAC,eAAe,CAAC,SAAS,CAAC,CAAA;AAC9B,SAAA;AACF,KAAA;IAED,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAI;QACrC,MAAM,eAAe,GAAG,QAAQ,CAAC,WAAW,CAAC,aAAa,CAAC,CAAA;QAC3D,eAAe,CAAC,SAAS,CAAC,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,CAAA;AAC9C,QAAA,IAAI,EAAE,EAAE;AACN,YAAA,EAAE,CAAC,aAAa,CAAC,eAAe,CAAC,CAAA;AACjC,YAAA,EAAE,CAAC,QAAQ,GAAG,UAAU,CAAC,EAAA;AACvB,gBAAA,MAAM,MAAM,GAAG,CAAC,CAAC,MAA0B,CAAA;AAC3C,gBAAA,IAAI,MAAM,EAAE;AACV,oBAAA,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,IAAI,EAAE,CAAA;AAChC,oBAAA,MAAM,GAAG,GAAG,CAAC,GAAG,KAAK,CAAC,CAAA;AACtB,oBAAA,GAAG,IAAI,GAAG,CAAC,OAAO,CAAC,IAAI,IAAG;;wBACxB,MAAM,IAAI,GAAG,IAAI,IAAI,CAAC,CAAC,IAAI,CAAC,EAAE;4BAC5B,IAAI,EAAE,IAAI,CAAC,IAAI;AAChB,yBAAA,CAAC,CAAA;wBACF,MAAM,GAAG,GAAG,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,CAAA;wBACrC,CAAA,EAAA,GAAA,GAAG,CAAC,aAAa,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAE,IAAI,CAAC,GAAG,CAAC,CAAA;AAC5B,wBAAA,CAAA,EAAA,GAAA,GAAG,CAAC,SAAS,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAE,IAAI,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,eAAe,EAAE,IAAI,EAAE,CAAC,CAAA;AAC7F,qBAAC,CAAC,CAAA;oBACF,MAAM,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC,CAAA;AACxC,oBAAA,MAAM,CAAC,KAAK,GAAG,EAAE,CAAA;AAClB,iBAAA;AACH,aAAC,CAAA;AACF,SAAA;AACH,KAAC,CAAC,CAAA;AACJ;;;;"}