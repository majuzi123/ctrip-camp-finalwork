{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/program.ts","../src/index.ts"],"sourcesContent":["import * as resolve from 'resolve'\n\nexport function resolveSync (id: string, opts: resolve.SyncOpts = {\n  basedir: __dirname\n}) {\n  return resolve.sync(id, opts)\n}\n","import { TaroPlatformWeb } from '@tarojs/service'\n\nimport { resolveSync } from './utils'\n\nimport type { IPluginContext, TConfig } from '@tarojs/service'\n\nconst compLibraryAlias = {\n  'vue': 'vue2',\n  'vue3': 'vue3'\n}\n\nconst PACKAGE_NAME = '@tarojs/plugin-platform-h5'\nexport default class H5 extends TaroPlatformWeb {\n  platform = 'h5'\n  runtimePath = `${PACKAGE_NAME}/dist/runtime`\n\n  constructor (ctx: IPluginContext, config: TConfig) {\n    super(ctx, config)\n    this.setupTransaction.addWrapper({\n      close () {\n        this.modifyWebpackConfig()\n      }\n    })\n  }\n\n  get framework () {\n    return this.ctx.initialConfig.framework || 'react'\n  }\n\n  get useHtmlComponents () {\n    return !!this.ctx.initialConfig.h5?.useHtmlComponents\n  }\n\n  get componentLibrary () {\n    if (this.useHtmlComponents && this.framework === 'react') {\n      return './runtime/components'\n    } else {\n      return `@tarojs/components/lib/${compLibraryAlias[this.framework] || 'react'}`\n    }\n  }\n\n  /**\n   * 修改 Webpack 配置\n   */\n  modifyWebpackConfig () {\n    this.ctx.modifyWebpackChain(({ chain }) => {\n      const rules = chain.module.rules\n      const script = rules.get('script')\n      const babelLoader = script.uses.get('babelLoader')\n      babelLoader.set('options', {\n        ...babelLoader.get('options'),\n        plugins: [\n          [require('babel-plugin-transform-taroapi'), {\n            packageName: '@tarojs/taro',\n            apis: require(resolveSync('./taroApis'))\n          }]\n        ]\n      })\n\n      const alias = chain.resolve.alias\n      // TODO 考虑集成到 taroComponentsPath 中，与小程序端对齐\n      alias.set('@tarojs/components$', require.resolve(this.componentLibrary))\n      alias.set('@tarojs/router$', require.resolve('@tarojs/router'))\n      alias.set('@tarojs/taro', require.resolve('./runtime/apis'))\n      chain.plugin('mainPlugin')\n        .tap(args => {\n          args[0].loaderMeta ||= {\n            extraImportForWeb: '',\n            execBeforeCreateWebApp: ''\n          }\n          switch (this.framework) {\n            case 'vue':\n              args[0].loaderMeta.extraImportForWeb += `import { initVue2Components } from '@tarojs/components'\\n`\n              args[0].loaderMeta.execBeforeCreateWebApp += `initVue2Components()\\n`\n              break\n            case 'vue3':\n              args[0].loaderMeta.extraImportForWeb += `import { initVue3Components } from '@tarojs/components'\\n`\n              args[0].loaderMeta.execBeforeCreateWebApp += `initVue3Components(component)\\n`\n              break\n            default:\n              if (this.useHtmlComponents) {\n                args[0].loaderMeta.extraImportForWeb += `import { PullDownRefresh } from '@tarojs/components'\\n`\n                args[0].loaderMeta.execBeforeCreateWebApp += `config.PullDownRefresh = PullDownRefresh\\n`\n              }\n          }\n          return args\n        })\n\n      // Note: 本地调试 stencil 组件库时，如果启用 sourceMap 则需要相关配置\n      chain.module.rule('map')\n        .test(/\\.map$/).type('json')\n      // Note: 生产环境默认不加载 map 文件\n      if (process.env.NODE_ENV === 'production') {\n        alias.set('.map$', false as any)\n      }\n    })\n  }\n}\n","import H5 from './program'\n\nimport type { IPluginContext } from '@tarojs/service'\n\n// Note: 让其它平台插件可以继承此平台\nexport { H5 }\n\nexport default (ctx: IPluginContext) => {\n  ctx.registerPlatform({\n    name: 'h5',\n    useConfigName: 'h5',\n    async fn ({ config }) {\n      const program = new H5(ctx, config)\n      await program.start()\n    }\n  })\n\n  ctx.modifyRunnerOpts(({ opts }) => {\n    opts.defineConstants ||= {}\n    opts.defineConstants.USE_HTML_COMPONENTS = JSON.stringify(!!opts.useHtmlComponents)\n    // TODO 为 postcss-html-transform 更新组件转换列表\n  })\n}\n\n"],"names":["resolve","TaroPlatformWeb"],"mappings":"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"}